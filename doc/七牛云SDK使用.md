# 七牛云SDK使用

通过kodo存储对象，服务端下发 带回调、带数据处理、带自定义参数 的凭证，客户端根据凭证上传视频，上传成功后七牛云回调服务端，服务端处理数据

## 时序图

![七牛云SDK使用.png](./poml/七牛云SDK使用.png)

## 设计思路

为保证访问密钥的安全性，采用服务端下发凭证的形式

上传文件主要集中于以下几个场景
1. 上传/更换头像
2. 上传视频
3. 上传封面/七牛云自动截取封面

设计callback接口时，考虑到以下两方面

1. 文件上传调用次数相对其它接口较少，且回调方处理数据任务量不大
2. callback由七牛云调用，处理数据前会检测是否为七牛云发起
3. 处理回调时，不同类型控制层代码相近

所以选择将三种类型全部集中于一个回调接口

在处理数据时，如上传视频时，需要知道上传用户、标题、视频类型等信息，需要客户端上传时，携带自定义参数，callbackBody定义如下：

```json
{
  "key": "$(key)",
  "file_type": "$(x:file_type)",
  "uid": "$(x:uid)",
  "cover_url": "$(x:cover_url)",
  "describe": "$(x:describe)",
  "title": "$(x:title)",
  "video_type_id": "$(x:video_type_id)"
}
```

服务端根据file_type判断上传类型(视频-携带封面/视频-不携带封面/封面/头像)，不同文件类型对应不同的参数校验，并单独处理

+ 封面：不做处理
+ 视频-携带封面：插入视频
+ 头像：修改user表 

对于视频-不携带封面：
1. 以用户头像做临时封面，插入视频
2. 将视频key做键，值为视频id，存入redis，半小时过期时间
3. 七牛云截取封面成功后，异步回调接口，根据视频key找到视频id，替换视频封面

服务端在注册上传凭证时，携带了预转持久化参数：`vframe/jpg/offset/1|saveas/bucket:${etag}.jpg`，七牛云会截取视频第一帧并持久化存储，在存储完成后，调用callback接口

callback在检测到请求中含有inputKey字段时，根据视频Key从redis取出视频id，并替换视频封面
