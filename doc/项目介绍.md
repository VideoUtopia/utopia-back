
# 项目介绍

## 功能介绍

utopia-back，实现功能如下：

1. 存储模块
   1. 获取文件上传Token - 携带回调与数据处理
   2. 上传文件回调接口 - 由七牛云调用
2. 视频模块 - 均支持分页
   1. 获取某类视频
   2. 获取推荐视频 - 优先拉取关注用户的视频、结束后拉取热门视频
   3. 获取热门视频 - 返回三小时内点赞量做多的视频
   4. 搜索视频 - 根据标题匹配视频
   5. 发布视频列表 - 获取该用户发布的视频
   6. 视频收藏列表 - 获取该用户收藏的视频
3. 交互模块
   1. 收藏/取消收藏
   2. 点赞/取消点赞
   3. 关注/取关
   4. 关注列表
   5. 粉丝列表
   6. 发布评论
   7. 获取评论列表
4. 用户模块
   1. 登录注册 - 获取JWT Token
   2. 获取用户信息
   3. 修改用户昵称

## 中间件介绍

+ 限频中间件：采用 **令牌桶** 对可针对不同接口配置不同的限流策略，同时支持对用户IP限流，防止用户恶意攻击，详见：[接口及IP限流](./接口及IP限流.md)
+ 鉴权模块：通过JWT进行用户鉴权，user_id作为payload
+ 参数校验：通过validator库对参数进行校验
+ 日志：使用zap重写Gorm和Gin日志，提供更好的日志输出控制和格式化选项，以及更好的日志级别管理和错误追踪能力

## 项目设计

### 数据库设计

#### 用户表

主要场景：
1. 通过id查询数据
2. 判断注册时username是否重复

索引：username-is_del 唯一索引

```MySQL
CREATE TABLE `users` (
                         `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                         `created_at` datetime(3) DEFAULT NULL,
                         `updated_at` datetime(3) DEFAULT NULL,
                         `is_del` bigint unsigned DEFAULT NULL,
                         `username` varchar(64) NOT NULL,
                         `password` varchar(64) NOT NULL,
                         `nickname` varchar(64) NOT NULL,
                         `avatar` varchar(64) NOT NULL,
                         `salt` varchar(8) NOT NULL,
                         PRIMARY KEY (`id`),
                         UNIQUE KEY `idx_uname_del` (`username`,`is_del`)
) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

#### 视频表

主要场景：
1. 根据id查询视频信息
2. 视频按照发布时间排序
3. 根据作者id查询视频信息

索引：created_time-deleted_at 索引
索引：author_id-deleted_at 索引

```MySQL
CREATE TABLE `videos` (
                          `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                          `created_at` datetime(3) DEFAULT NULL,
                          `updated_at` datetime(3) DEFAULT NULL,
                          `deleted_at` datetime(3) DEFAULT NULL,
                          `author_id` bigint unsigned NOT NULL,
                          `play_url` varchar(256) NOT NULL,
                          `cover_url` varchar(256) NOT NULL,
                          `video_type_id` bigint unsigned NOT NULL,
                          `describe` varchar(256) DEFAULT NULL,
                          `title` varchar(256) DEFAULT NULL,
                          PRIMARY KEY (`id`),
                          KEY `idx_ctime_del` (`created_at`,`deleted_at`),
                          KEY `idx_author_del` (`author_id`,`deleted_at`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

#### 点赞表

使用场景：
1. 用户是否为该视频点赞
2. 三小时内点赞量统计

索引：
+ user_id-video_id 唯一索引
+ updated_id 索引
+ video_id-status 索引

```MySQL
CREATE TABLE `likes` (
                         `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                         `created_at` datetime(3) DEFAULT NULL,
                         `updated_at` datetime(3) DEFAULT NULL,
                         `status` tinyint(1) DEFAULT NULL,
                         `video_id` bigint unsigned NOT NULL,
                         `user_id` bigint unsigned NOT NULL,
                         PRIMARY KEY (`id`),
                         UNIQUE KEY `idx_uid_vid` (`user_id`,`video_id`),
                         KEY `idx_likes_updated_at` (`updated_at`),
                         KEY `idx_vid_status` (`video_id`,`status`)
) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

#### 点赞数表

使用场景：根据视频id查询点赞数

索引：
+ video_id 唯一索引
+ updated_at 索引

```MySQL
CREATE TABLE `like_counts` (
                               `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                               `created_at` datetime(3) DEFAULT NULL,
                               `updated_at` datetime(3) DEFAULT NULL,
                               `count` bigint NOT NULL DEFAULT '0',
                               `video_id` bigint unsigned NOT NULL,
                               PRIMARY KEY (`id`),
                               UNIQUE KEY `idx_vid` (`video_id`),
                               KEY `idx_like_counts_updated_at` (`updated_at`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

#### 关注表

使用场景：
1. 自己是否关注过对方
2. 对方是否关注过自己

索引：
+ follow_id-user_id 唯一索引
+ user_id-follow_id 唯一索引

```MySQL
CREATE TABLE `follows` (
                           `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                           `created_at` datetime(3) DEFAULT NULL,
                           `updated_at` datetime(3) DEFAULT NULL,
                           `status` tinyint(1) NOT NULL,
                           `follow_id` bigint unsigned NOT NULL,
                           `user_id` bigint unsigned NOT NULL,
                           PRIMARY KEY (`id`),
                           UNIQUE KEY `idx_funId_uid` (`follow_id`,`user_id`),
                           UNIQUE KEY `idx_uid_funId` (`user_id`,`follow_id`)
) ENGINE=InnoDB AUTO_INCREMENT=67 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

#### 收藏表

使用场景：
1. 查看用户是否收藏
2. 查看视频收藏数

索引：
+ user_id-video_id 唯一索引
+ video_id-status 索引

```MySQL
CREATE TABLE `favorites` (
                             `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                             `created_at` datetime(3) DEFAULT NULL,
                             `updated_at` datetime(3) DEFAULT NULL,
                             `status` tinyint(1) NOT NULL DEFAULT '0',
                             `video_id` bigint unsigned NOT NULL,
                             `user_id` bigint unsigned NOT NULL,
                             PRIMARY KEY (`id`),
                             UNIQUE KEY `idx_uid_vid` (`user_id`,`video_id`),
                             KEY `idx_vid_status` (`video_id`,`status`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

#### 评论表

使用场景：
1. 查看自己的评论
2. 查看视频的评论
3. 评论按照发布时间排序

索引：
+ updated_at 索引
+ video_id 索引
+ user_id 索引

```MySQL
CREATE TABLE `comments` (
                          `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                          `created_at` datetime(3) DEFAULT NULL,
                          `updated_at` datetime(3) DEFAULT NULL,
                          `video_id` bigint unsigned NOT NULL,
                          `user_id` bigint unsigned NOT NULL,
                          `content` longtext NOT NULL,
                          PRIMARY KEY (`id`),
                          KEY `idx_comments_updated_at` (`updated_at`),
                          KEY `idx_comments_video_id` (`video_id`),
                          KEY `idx_comments_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 缓存设计

#### 热门视频缓存设计

zset存储，异步刷取DB，获取一段时间内点赞量增长最高的视频；version控制缓存版本，避免用户因热门视频突然更新而影响体验。详见：[热门视频设计方案](./热门视频设计方案.md)

#### 点赞缓存设计

判断用户是否点赞通过Hash类型存储，以视频id维度进行冷热数据分离，详见：[判断用户是否点赞缓存方案](./判断用户是否点赞缓存方案.md)

同时点赞数原则上是不要求强一致的，将视频点赞数以string形式写入缓存，当用户点赞时，直接修改缓存，之后消息队列异步修改DB即可，业务侧可以接受，用户体验也较好，但因时间原因，没有接入消息队列，目前是修改缓存后同步改DB
