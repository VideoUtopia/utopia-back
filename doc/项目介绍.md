
# 项目介绍

## 功能介绍

utopia-back，实现功能如下：

1. 存储模块
   1. 获取文件上传Token - 携带回调与数据处理
   2. 上传文件回调接口 - 由七牛云调用
2. 视频模块 - 均支持分页
   1. 获取某类视频
   2. 获取推荐视频 - 优先拉取关注用户的视频、结束后拉取热门视频
   3. 获取热门视频 - 返回三小时内点赞量做多的视频
   4. 搜索视频 - 根据标题匹配视频
   5. 发布视频列表 - 获取该用户发布的视频
   6. 视频收藏列表 - 获取该用户收藏的视频
3. 交互模块
   1. 收藏/取消收藏
   2. 点赞/取消点赞
   3. 关注/取关
   4. 关注列表
   5. 粉丝列表
   6. 发布评论
   7. 获取评论列表
4. 用户模块
   1. 登录注册 - 获取JWT Token
   2. 获取用户信息
   3. 修改用户昵称

## 中间件介绍

### 限频中间件

采用 **令牌桶** 对可针对不同接口配置不同的限流策略，同时支持对用户IP限流，防止用户恶意攻击，实现代码见`utopia-back\http\middleware\ratelimit.go`，注册代码如下：

```go
// InitRateLimit 注册限流
func InitRateLimit() {
	// 需要限流的接口在此注册
	// 参考文章：https://blog.csdn.net/m0_52528053/article/details/127294249
	middleware.BucketMap["/api/v1/upload/token"] = &middleware.BucketConf{
		// 每10ms产生5个token，最多存储10个token
		Bucket: ratelimit.NewBucketWithQuantum(10*time.Millisecond, 10, 5),
		// 最大等待时间
		MaxWait: 20 * time.Millisecond,

		IpRateConf: &middleware.IpRateConf{
			FillInterval: time.Second,
			Capacity:     5,
		},
	}
	middleware.BucketMap["/api/v1/upload/callback"] = &middleware.BucketConf{
		Bucket:  ratelimit.NewBucketWithQuantum(10*time.Millisecond, 10, 5),
		MaxWait: 20 * time.Millisecond,
	}
	middleware.BucketMap["default"] = &middleware.BucketConf{
		Bucket:  ratelimit.NewBucketWithQuantum(10*time.Millisecond, 100, 20),
		MaxWait: 10 * time.Millisecond,
	}
	middleware.FillDefault()
}
```

### 鉴权模块

通过JWT进行

#### 限频

#### 日志

#### 参数校验

### 视频模块

### 存储模块


### 交互
    ### 点赞模块
    
    ### 关注模块
    
    ### 收藏模块
    
    ### 评论模块


## 项目设计

## 数据库设计

### 用户表

主要场景：
1. 通过id查询数据
2. 判断注册时username是否重复

索引：username-is_del 唯一索引

```MySQL
CREATE TABLE `users` (
                         `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                         `created_at` datetime(3) DEFAULT NULL,
                         `updated_at` datetime(3) DEFAULT NULL,
                         `is_del` bigint unsigned DEFAULT NULL,
                         `username` varchar(64) NOT NULL,
                         `password` varchar(64) NOT NULL,
                         `nickname` varchar(64) NOT NULL,
                         `avatar` varchar(64) NOT NULL,
                         `salt` varchar(8) NOT NULL,
                         PRIMARY KEY (`id`),
                         UNIQUE KEY `idx_uname_del` (`username`,`is_del`)
) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 视频表

主要场景：
1. 根据id查询视频信息
2. 视频按照发布时间排序
3. 根据作者id查询视频信息

索引：created_time-deleted_at 索引
索引：author_id-deleted_at 索引

```MySQL
CREATE TABLE `videos` (
                          `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                          `created_at` datetime(3) DEFAULT NULL,
                          `updated_at` datetime(3) DEFAULT NULL,
                          `deleted_at` datetime(3) DEFAULT NULL,
                          `author_id` bigint unsigned NOT NULL,
                          `play_url` varchar(256) NOT NULL,
                          `cover_url` varchar(256) NOT NULL,
                          `video_type_id` bigint unsigned NOT NULL,
                          `describe` varchar(256) DEFAULT NULL,
                          `title` varchar(256) DEFAULT NULL,
                          PRIMARY KEY (`id`),
                          KEY `idx_ctime_del` (`created_at`,`deleted_at`),
                          KEY `idx_author_del` (`author_id`,`deleted_at`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 点赞表

使用场景：
1. 用户是否为该视频点赞
2. 三小时内点赞量统计

索引：
+ user_id-video_id 唯一索引
+ updated_id 索引
+ video_id-status 索引

```MySQL
CREATE TABLE `likes` (
                         `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                         `created_at` datetime(3) DEFAULT NULL,
                         `updated_at` datetime(3) DEFAULT NULL,
                         `status` tinyint(1) DEFAULT NULL,
                         `video_id` bigint unsigned NOT NULL,
                         `user_id` bigint unsigned NOT NULL,
                         PRIMARY KEY (`id`),
                         UNIQUE KEY `idx_uid_vid` (`user_id`,`video_id`),
                         KEY `idx_likes_updated_at` (`updated_at`),
                         KEY `idx_vid_status` (`video_id`,`status`)
) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 点赞数表

使用场景：根据视频id查询点赞数

索引：
+ video_id 唯一索引
+ updated_at 索引

```MySQL
CREATE TABLE `like_counts` (
                               `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                               `created_at` datetime(3) DEFAULT NULL,
                               `updated_at` datetime(3) DEFAULT NULL,
                               `count` bigint NOT NULL DEFAULT '0',
                               `video_id` bigint unsigned NOT NULL,
                               PRIMARY KEY (`id`),
                               UNIQUE KEY `idx_vid` (`video_id`),
                               KEY `idx_like_counts_updated_at` (`updated_at`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 关注表

使用场景：
1. 自己是否关注过对方
2. 对方是否关注过自己

索引：
+ follow_id-user_id 唯一索引
+ user_id-follow_id 唯一索引

```MySQL
CREATE TABLE `follows` (
                           `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                           `created_at` datetime(3) DEFAULT NULL,
                           `updated_at` datetime(3) DEFAULT NULL,
                           `status` tinyint(1) NOT NULL,
                           `follow_id` bigint unsigned NOT NULL,
                           `user_id` bigint unsigned NOT NULL,
                           PRIMARY KEY (`id`),
                           UNIQUE KEY `idx_funId_uid` (`follow_id`,`user_id`),
                           UNIQUE KEY `idx_uid_funId` (`user_id`,`follow_id`)
) ENGINE=InnoDB AUTO_INCREMENT=67 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 收藏表

使用场景：
1. 查看用户是否收藏
2. 查看视频收藏数

索引：
+ user_id-video_id 唯一索引
+ video_id-status 索引

```MySQL
CREATE TABLE `favorites` (
                             `id` bigint unsigned NOT NULL AUTO_INCREMENT,
                             `created_at` datetime(3) DEFAULT NULL,
                             `updated_at` datetime(3) DEFAULT NULL,
                             `status` tinyint(1) NOT NULL DEFAULT '0',
                             `video_id` bigint unsigned NOT NULL,
                             `user_id` bigint unsigned NOT NULL,
                             PRIMARY KEY (`id`),
                             UNIQUE KEY `idx_uid_vid` (`user_id`,`video_id`),
                             KEY `idx_vid_status` (`video_id`,`status`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

### 评论表

使用场景：
1. 查看自己的评论
2. 查看视频的评论
3. 评论按照发布时间排序

索引：
+ updated_at 索引
+ video_id 索引
+ user_id 索引

```MySQL
CREATE TABLE `comments` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `created_at` datetime(3) DEFAULT NULL,
  `updated_at` datetime(3) DEFAULT NULL,
  `video_id` bigint unsigned NOT NULL,
  `user_id` bigint unsigned NOT NULL,
  `content` longtext NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_comments_updated_at` (`updated_at`),
  KEY `idx_comments_video_id` (`video_id`),
  KEY `idx_comments_user_id` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=17 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

结构待安排

+ 数据库设计
+ 项目结构设计
+ 日志记录
+ 安全？IP限频、Token、salt
