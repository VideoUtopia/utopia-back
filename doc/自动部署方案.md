
# 自动部署方案

## Webhooks

持续部署采用 Github 的 Webhooks，当提交代码时，Github 将向所配置的 URL 发送 POST 请求。用户可以根据该请求感知到代码发生了更改，重新拉取代码并部署。

## hookdoo

我们可以写一个接口，监听来自 Github 的请求，检测到后执行 shell 脚本，重新构建项目。当然也可以直接使用 hookdoo

Hookdoo 是一个可编程的 webhook 网关，可以安全地在服务器上运行自定义的构建、部署和代理脚本，我们在创建 Service、Hook 后，配置到 Github 上，即可完成自动部署

## 构建运行

我们需要在 hookdoo 中编写要执行的脚本，流程如下：

1. 更新 master 分支
2. 查看服务器占用8080接口应用的 pid
3. kill 该进程
4. 构建并运行服务，输出写入日志

测试无误后，即可实现自动部署了。当然，使用 Docker 来跑效果会更好，但因时间较为紧张，没有用 Docker

```shell
#!/bin/bash

# 检查8080端口的占用情况
port=8080
pid=$(lsof -t -i:$port)

if [ -z "$pid" ]; then
  echo "端口 $port 没有被占用。"
else
  echo "端口 $port 被进程 $pid 占用。"

  # 终止占用8080端口的进程
  echo "终止进程 $pid ..."
  kill $pid

fi

echo "开始启动Go程序..."
nohup /usr/local/go/bin/go run main.go > output.log 2>&1 &
sleep 2 # 等待一段时间以确保程序已经启动
pid=$!
if [ -n "$(ps -p $pid -o pid=)" ]; then
  echo "Go程序已成功启动。"
else
  echo "Go程序启动失败，请检查错误信息。"
  exit 1
fi

# 检查Go程序的执行结果
if [ $? -eq 0 ]; then
  echo "Go程序执行成功。"
else
  echo "Go程序执行失败。"
  exit 1
fi
```
